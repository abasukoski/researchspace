[[!-- <ol class="page-breadcrumb">
  <li>
    <semantic-link-container uri="http://www.researchspace.org/resource/ThinkingFrames" 
                            urlqueryparam-view='admin'
                            urlqueryparam-resource-iri='[[resolvePrefix "rsp:admin"]]'
                            urlqueryparam-custom-label='Administration'>
      <div>Administration</div>
    </semantic-link-container>
  </li>
  <li class="active">Apps and Storages</li>
</ol> --]]

<div class="page__grid-container application-page-container">
  <div class='page__content-container'>

    [[> rsp:adminPageHeader title="Apps and Storages" ]]

    <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;"> 
      <h2>App upload</h2>
      [[#if (hasPermission "app:upload")]]
        <mp-overlay-dialog title="Upload & deploy App" type="modal" >
          <mp-overlay-dialog-trigger>
            <button class="btn btn-action btn-textAndIcon" title="Import">
              <rs-icon icon-type='rounded' icon-name='upload' symbol='true'></rs-icon>
              <span>Upload & deploy App</span>
            </button>
          </mp-overlay-dialog-trigger>
          <mp-overlay-dialog-content>
            <div>
                <div class="documentation-section documentation-section-withIcon" style="margin-bottom: 10px;">
                  <div class="documentation-section-icon-container">
                    <i class="fa fa-info"></i>
                  </div>

                  <div style="flex: 1;"> 
                    <div class="documentation-section-title">Info</div>
                    <div class="documentation-section-content">
                      Apps need a platform restart in order to be installed properly. Refer to the 
                      <semantic-link  uri="http://www.researchspace.org/resource/ThinkingFrames" 
                                      urlqueryparam-view='help'
                                      urlqueryparam-resource-iri='[[resolvePrefix "Help:AppDeployment"]]'
                                      urlqueryparam-custom-label='App deployment'>
                        <span class="text-underline" style="cursor: pointer;">app deployment</span>
                      </semantic-link> help for further details.
                    </div>
                  </div>
                </div>
                <mp-app-upload></mp-app-upload>
            </div>
          </mp-overlay-dialog-content>
        </mp-overlay-dialog>
      [[/if]]
    </div>

    <mp-event-target-template-render id='documentation-adminApps' template='{{> template}}'>
      <template id='template'>
        {{#if hideMessage}}
        {{else}}
          <div style="margin-bottom: 20px;">
            <div class="documentation-section documentation-section-withIcon">
              <div class="documentation-section-icon-container">
                <i class="fa fa-info"></i>
              </div>

              <div style="flex: 1;"> 
                <div class="documentation-section-title">Info</div>
                <div class="documentation-section-content">
                  Every app has exactly one associated storage. The storage ID is equal to the app ID. <br>
                  If no explicit storage is defined for an 
                  <semantic-link  uri="http://www.researchspace.org/resource/ThinkingFrames" 
                                  urlqueryparam-view='help'
                                  urlqueryparam-resource-iri='[[resolvePrefix "Help:AppsMechanism"]]'
                                  urlqueryparam-custom-label='App mechanism'>
                    <span class="text-underline" style="cursor: pointer;">app</span>
                  </semantic-link>,
                  the platform creates a standard, non-versioned file storage
                  within the root directory of the respective app.
                </div>
              </div>
              <mp-event-trigger id='{{viewId}}-documentation-adminApps-close-trigger'
                                type='Component.TemplateUpdate'
                                data='{ "hideMessage": "true" }'
                                targets='["documentation-adminApps"]'
                          >
                  <button class="btn btn-documentation">
                    <rs-icon icon-type="rounded" icon-name="close" symbol="true"></rs-icon>
                  </button>
              </mp-event-trigger>
            </div> 
          </div>
        {{/if}}
      </template>
    </mp-event-target-template-render>

    <mp-json-renderer get-url='/rest/admin/apps'></mp-json-renderer>

    <h2 style="margin-top:40px;">Connected storages</h2>
    <div class="documentation-section documentation-section-withIcon" style="margin-bottom: 10px;">
      <div class="documentation-section-icon-container">
        <i class="fa fa-info"></i>
      </div>

      <div style="flex: 1;"> 
        <div class="documentation-section-title">Info</div>
        <div class="documentation-section-content">
          Storages in ascending order of priority (for more details look at
          <semantic-link  uri="http://www.researchspace.org/resource/ThinkingFrames" 
                          urlqueryparam-view='help'
                          urlqueryparam-resource-iri='[[resolvePrefix "Help:Storage"]]'
                          urlqueryparam-custom-label='Storage'>
            <span class="text-underline" style="cursor: pointer;">Storage guide</span>
          </semantic-link>)
        </div>
      </div>
    </div>

    <mp-json-renderer get-url='/rest/admin/storages' template='{{> storages}}'>
      <template id='storages'>
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Storage Id</th>
              <th>Storage Kind</th>
              <th>Mutable Storage</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each this}}
            <tr>
              <td>{{@index}}</td>
              <td>{{id}}</td>
              <td>{{storageKind}}</td>
              <td>{{mutableStorage}}</td>
              <td>
                <mp-overlay-dialog title="Download - App artefacts" type="modal">
                  <mp-overlay-dialog-trigger>
                    <button class="btn btn-default btn-textAndIcon">
                      <rs-icon icon-type="rounded" icon-name="file_download" symbol="true"></rs-icon>
                      Download
                    </button>
                  </mp-overlay-dialog-trigger>
                  <mp-overlay-dialog-content>
                    <p>
                      The download will generate a ZIP bundle of all non-binary app artefacts
                      (templates, config files, ldp assets) only. If the storage does not contain any of such,
                      the zip will be empty.
                    </p>
                    <p>
                      Dependent on the underlying storage and
                      the number and size of the app artefacts, generating the ZIP may take some time.
                      Please be patient and <b>do not try to re-start</b> the download,
                      i.e. by pressing the download button twice.<br>
                    </p>
                    <div style="display: flex; justify-content: end;">
                      <mp-file-download delay=2000 post-action="reload"
                        download-url="/rest/admin/storages/{{id}}/zip">
                        <button class="btn btn-action btn-textAndIcon" title="Download">
                          <rs-icon icon-type="rounded" icon-name="file_download" symbol="true"></rs-icon>
                          Download
                        </button>
                      </mp-file-download>
                    </div>
                  </mp-overlay-dialog-content>
                </mp-overlay-dialog>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </template>
    </mp-json-renderer>

  </div>
</div>
